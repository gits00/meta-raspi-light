From f3db7336d9eaf36a2567466703370262291f343e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andreas=20M=C3=BCller?= <schnitzeltony@gmail.com>
Date: Wed, 15 Aug 2018 13:10:46 +0200
Subject: [PATCH] VC4: enable tile neon asm for aarch64
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The code is there and seems to work - is there something I missed?

* autotools Makefiles do not support 'or'. Work arounf with HAVE_NEON_ASM in
  configure.ac.
* meson: am still building with autotools - so meson was not yet tested.
* aarch64 does not support -mfpu=neon

Upstream-Status: Pending

Signed-off-by: Andreas MÃ¼ller <schnitzeltony@gmail.com>
---
 configure.ac                        | 1 +
 src/gallium/drivers/vc4/Makefile.am | 7 +++++--
 src/gallium/drivers/vc4/meson.build | 4 ++--
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/configure.ac b/configure.ac
index c2155a541b..89f7167641 100644
--- a/configure.ac
+++ b/configure.ac
@@ -3004,6 +3004,7 @@ AM_CONDITIONAL(HAVE_SPARC_ASM, test "x$asm_arch" = xsparc)
 AM_CONDITIONAL(HAVE_PPC64LE_ASM, test "x$asm_arch" = xppc64le)
 AM_CONDITIONAL(HAVE_AARCH64_ASM, test "x$asm_arch" = xaarch64)
 AM_CONDITIONAL(HAVE_ARM_ASM, test "x$asm_arch" = xarm)
+AM_CONDITIONAL(HAVE_NEON_ASM, test "x$asm_arch" = xarm -o "x$asm_arch" = xaarch64)
 
 AC_SUBST([NINE_MAJOR], 1)
 AC_SUBST([NINE_MINOR], 0)
diff --git a/src/gallium/drivers/vc4/Makefile.am b/src/gallium/drivers/vc4/Makefile.am
index 4c7dd843da..ada79d0c4f 100644
--- a/src/gallium/drivers/vc4/Makefile.am
+++ b/src/gallium/drivers/vc4/Makefile.am
@@ -46,11 +46,14 @@ libvc4_la_LIBADD = \
 	$(SIM_LIB) \
 	$()
 
-if HAVE_ARM_ASM
+if HAVE_NEON_ASM
 noinst_LTLIBRARIES += libvc4_neon.la
 libvc4_la_LIBADD += libvc4_neon.la
 libvc4_neon_la_SOURCES = $(NEON_C_SOURCES)
-libvc4_neon_la_CFLAGS = $(AM_CFLAGS) -mfpu=neon
+libvc4_neon_la_CFLAGS = $(AM_CFLAGS)
+if HAVE_ARM_ASM
+libvc4_neon_la_CFLAGS += -mfpu=neon
+endif
 endif
 
 libvc4_la_LDFLAGS = $(SIM_LDFLAGS)
diff --git a/src/gallium/drivers/vc4/meson.build b/src/gallium/drivers/vc4/meson.build
index 50adcc25f2..59bef3f19d 100644
--- a/src/gallium/drivers/vc4/meson.build
+++ b/src/gallium/drivers/vc4/meson.build
@@ -82,14 +82,14 @@ files_libvc4 = files(
 )
 
 libvc4_neon = []
-if with_asm_arch == 'arm'
+if with_asm_arch == 'arm' or with_asm_arch == 'aarch64'
   libvc4_neon = static_library(
     'vc4_neon',
     'vc4_tiling_lt_neon.c',
     include_directories : [
       inc_src, inc_include, inc_gallium, inc_gallium_aux, inc_broadcom
     ],
-    c_args : '-mfpu=neon',
+    c_args : with_asm_arch == 'arm' ? '-mfpu=neon' : '',
   )
 endif
 
-- 
2.14.4

